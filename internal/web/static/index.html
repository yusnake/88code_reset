<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>88code è®¢é˜…é‡ç½®ç®¡ç†åå°</title>
    <!-- Tailwind CSS v3.0 CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-page" class="min-h-screen flex items-center justify-center px-4 bg-gradient-to-br from-primary to-secondary">
        <div class="max-w-md w-full">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ” 88code ç®¡ç†åå°</h1>
                    <p class="text-gray-600">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥ç»§ç»­</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç®¡ç†å‘˜å¯†ç </label>
                        <input
                            type="password"
                            id="login-password"
                            placeholder="è¯·è¾“å…¥å¯†ç "
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition"
                            onkeypress="if(event.key === 'Enter') login()"
                        >
                    </div>
                    <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                    <button
                        onclick="login()"
                        class="w-full bg-gradient-to-r from-primary to-secondary text-white font-semibold py-3 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200"
                    >
                        ç™»å½•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç®¡ç†ç•Œé¢ -->
    <div id="main-app" class="hidden">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="bg-gradient-to-r from-primary to-secondary text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold">ğŸš€ 88code è®¢é˜…é‡ç½®ç®¡ç†</h1>
                    <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                        é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="w-2 h-8 bg-primary rounded-full mr-3"></span>
                    ğŸ“Š ç³»ç»ŸçŠ¶æ€
                </h2>
                <div id="status-loading" class="text-center py-8 text-gray-500">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-primary"></div>
                    <p class="mt-2">åŠ è½½ä¸­...</p>
                </div>
                <div id="status-content" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border-l-4 border-blue-500">
                            <div class="text-sm text-blue-600 font-medium mb-1">å½“å‰æ—¶é—´</div>
                            <div id="current-time" class="text-xl font-bold text-blue-900">--</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border-l-4 border-green-500">
                            <div class="text-sm text-green-600 font-medium mb-1">ä¸‹æ¬¡é‡ç½®</div>
                            <div id="next-reset" class="text-xl font-bold text-green-900">--</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border-l-4 border-purple-500">
                            <div class="text-sm text-purple-600 font-medium mb-1">Token æ€»æ•°</div>
                            <div id="total-tokens" class="text-xl font-bold text-purple-900">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border-l-4 border-orange-500">
                            <div class="text-sm text-orange-600 font-medium mb-1">å·²å¯ç”¨ Token</div>
                            <div id="enabled-tokens" class="text-xl font-bold text-orange-900">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é‡ç½®é…ç½® -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="w-2 h-8 bg-primary rounded-full mr-3"></span>
                    âš™ï¸ é‡ç½®é…ç½®
                </h2>
                <div id="config-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>
                <div id="config-success" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4"></div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- ç¬¬ä¸€æ¬¡é‡ç½® -->
                    <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-indigo-900">ğŸŒ… ç¬¬ä¸€æ¬¡é‡ç½® (18:50)</h3>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="first-enabled" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-indigo-700 mb-2">è§¦å‘é˜ˆå€¼ (%)</label>
                            <input
                                type="number"
                                id="first-threshold"
                                min="0"
                                max="100"
                                value="70"
                                class="w-full px-4 py-2 border border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                            >
                            <p class="text-xs text-indigo-600 mt-2">å½“é¢åº¦ä½äºæ­¤ç™¾åˆ†æ¯”æ—¶è§¦å‘é‡ç½®</p>
                        </div>
                    </div>

                    <!-- ç¬¬äºŒæ¬¡é‡ç½® -->
                    <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-pink-900">ğŸŒ™ ç¬¬äºŒæ¬¡é‡ç½® (23:55)</h3>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="second-enabled" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-pink-700 mb-2">è§¦å‘é˜ˆå€¼ (%)</label>
                            <input
                                type="number"
                                id="second-threshold"
                                min="0"
                                max="100"
                                value="100"
                                class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent outline-none"
                            >
                            <p class="text-xs text-pink-600 mt-2">å½“é¢åº¦ä½äºæ­¤ç™¾åˆ†æ¯”æ—¶è§¦å‘é‡ç½®</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button
                        onclick="saveConfig()"
                        class="bg-gradient-to-r from-primary to-secondary text-white font-semibold px-6 py-3 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200"
                    >
                        ğŸ’¾ ä¿å­˜é…ç½®
                    </button>
                    <button
                        onclick="manualReset('first')"
                        class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200"
                    >
                        ğŸ”„ æ‰‹åŠ¨è§¦å‘ç¬¬ä¸€æ¬¡é‡ç½®
                    </button>
                    <button
                        onclick="manualReset('second')"
                        class="bg-gradient-to-r from-pink-500 to-pink-600 text-white font-semibold px-6 py-3 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200"
                    >
                        ğŸ”„ æ‰‹åŠ¨è§¦å‘ç¬¬äºŒæ¬¡é‡ç½®
                    </button>
                </div>
            </div>

            <!-- Token ç®¡ç† -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <span class="w-2 h-8 bg-primary rounded-full mr-3"></span>
                        ğŸ”‘ Token ç®¡ç†
                    </h2>
                    <div class="flex gap-3">
                        <button
                            onclick="showAddTokenModal()"
                            class="bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200 flex items-center gap-2"
                        >
                            <span class="text-xl">â•</span> æ·»åŠ  Token
                        </button>
                        <button
                            onclick="showBatchAddTokenModal()"
                            class="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200 flex items-center gap-2"
                        >
                            <span class="text-xl">ğŸ“</span> æ‰¹é‡æ·»åŠ 
                        </button>
                    </div>
                </div>
                <div id="token-loading" class="text-center py-8 text-gray-500">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-primary"></div>
                    <p class="mt-2">åŠ è½½ä¸­...</p>
                </div>
                <div id="token-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ  Token æ¨¡æ€æ¡† -->
    <div id="add-token-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">â• æ·»åŠ æ–° Token</h3>
            <div id="add-token-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm"></div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Token åç§°</label>
                    <input
                        type="text"
                        id="new-token-name"
                        placeholder="ä¾‹å¦‚: è´¦å·A"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                    <input
                        type="text"
                        id="new-token-apikey"
                        placeholder="sk-ant-..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                    >
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button
                    onclick="closeAddTokenModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg transition"
                >
                    å–æ¶ˆ
                </button>
                <button
                    onclick="addToken()"
                    class="flex-1 bg-gradient-to-r from-primary to-secondary text-white font-semibold py-2 rounded-lg hover:shadow-lg transition"
                >
                    æ·»åŠ 
                </button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ·»åŠ  Token æ¨¡æ€æ¡† -->
    <div id="batch-add-token-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 transform transition-all">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ æ‰¹é‡æ·»åŠ  Token</h3>
            <div id="batch-add-token-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm"></div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Token åç§°å‰ç¼€ï¼ˆå¯é€‰ï¼‰</label>
                    <input
                        type="text"
                        id="batch-token-prefix"
                        placeholder="ä¾‹å¦‚: è´¦å·"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                    >
                    <p class="text-xs text-gray-500 mt-1">å¦‚æœä¸å¡«ï¼Œå°†è‡ªåŠ¨å‘½åä¸º Token-1, Token-2...</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Keysï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                    <textarea
                        id="batch-token-apikeys"
                        rows="10"
                        placeholder="sk-ant-...&#10;sk-ant-...&#10;sk-ant-..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none font-mono text-sm"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">æ”¯æŒå¤šä¸ª API Keyï¼Œæ¯è¡Œä¸€ä¸ª</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button
                    onclick="closeBatchAddTokenModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg transition"
                >
                    å–æ¶ˆ
                </button>
                <button
                    onclick="batchAddTokens()"
                    class="flex-1 bg-gradient-to-r from-primary to-secondary text-white font-semibold py-2 rounded-lg hover:shadow-lg transition"
                >
                    æ‰¹é‡æ·»åŠ 
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let adminToken = '';

        // ç™»å½•åŠŸèƒ½
        function login() {
            const password = document.getElementById('login-password').value.trim();
            if (!password) {
                showLoginError('è¯·è¾“å…¥å¯†ç ');
                return;
            }

            adminToken = password;
            localStorage.setItem('adminToken', adminToken);

            // æµ‹è¯•è®¤è¯
            apiRequest('/api/status', { method: 'GET' })
                .then(() => {
                    document.getElementById('login-page').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    initApp();
                })
                .catch(err => {
                    showLoginError('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
                    adminToken = '';
                    localStorage.removeItem('adminToken');
                });
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 3000);
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            loadStatus();
            loadConfig();
            loadTokens();
            setInterval(loadStatus, 30000);
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                adminToken = savedToken;
                apiRequest('/api/status', { method: 'GET' })
                    .then(() => {
                        document.getElementById('login-page').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        initApp();
                    })
                    .catch(() => {
                        localStorage.removeItem('adminToken');
                    });
            }
        };

        // API è¯·æ±‚å°è£…
        function apiRequest(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminToken}`
            };

            return fetch(API_BASE + url, {
                ...options,
                headers: { ...headers, ...options.headers }
            }).then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                    }
                    return response.json().then(data => {
                        throw new Error(data.error || 'Request failed');
                    });
                }
                return response.json();
            });
        }

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        function loadStatus() {
            apiRequest('/api/status')
                .then(data => {
                    document.getElementById('status-loading').classList.add('hidden');
                    document.getElementById('status-content').classList.remove('hidden');

                    const currentTime = new Date(data.current_time).toLocaleString('zh-CN');
                    const nextResetTime = new Date(data.next_reset_time).toLocaleString('zh-CN');
                    const resetType = data.next_reset_type === 'first' ? 'ç¬¬ä¸€æ¬¡' : 'ç¬¬äºŒæ¬¡';

                    document.getElementById('current-time').textContent = currentTime;
                    document.getElementById('next-reset').textContent = `${nextResetTime} (${resetType})`;
                    document.getElementById('total-tokens').textContent = data.total_tokens;
                    document.getElementById('enabled-tokens').textContent = data.enabled_tokens;
                })
                .catch(err => console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', err));
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            apiRequest('/api/config')
                .then(data => {
                    document.getElementById('first-enabled').checked = data.first_reset.enabled;
                    document.getElementById('first-threshold').value = data.first_reset.threshold_percent;
                    document.getElementById('second-enabled').checked = data.second_reset.enabled;
                    document.getElementById('second-threshold').value = data.second_reset.threshold_percent;
                })
                .catch(err => console.error('åŠ è½½é…ç½®å¤±è´¥:', err));
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const config = {
                first_reset: {
                    enabled: document.getElementById('first-enabled').checked,
                    hour: 18,
                    minute: 50,
                    threshold_percent: parseFloat(document.getElementById('first-threshold').value)
                },
                second_reset: {
                    enabled: document.getElementById('second-enabled').checked,
                    hour: 23,
                    minute: 55,
                    threshold_percent: parseFloat(document.getElementById('second-threshold').value)
                },
                timezone: 'Asia/Shanghai',
                web_port: 8966
            };

            apiRequest('/api/config', {
                method: 'PUT',
                body: JSON.stringify(config)
            })
            .then(data => {
                const successDiv = document.getElementById('config-success');
                successDiv.textContent = 'âœ… é…ç½®ä¿å­˜æˆåŠŸï¼';
                successDiv.classList.remove('hidden');
                setTimeout(() => successDiv.classList.add('hidden'), 3000);
            })
            .catch(err => {
                const errorDiv = document.getElementById('config-error');
                errorDiv.textContent = 'âŒ ä¿å­˜å¤±è´¥: ' + err.message;
                errorDiv.classList.remove('hidden');
            });
        }

        // åŠ è½½ Token åˆ—è¡¨
        function loadTokens() {
            document.getElementById('token-loading').classList.remove('hidden');

            apiRequest('/api/tokens')
                .then(data => {
                    document.getElementById('token-loading').classList.add('hidden');
                    renderTokens(data.tokens || []);
                })
                .catch(err => {
                    document.getElementById('token-loading').classList.add('hidden');
                    console.error('åŠ è½½ Token å¤±è´¥:', err);
                });
        }

        // æ¸²æŸ“ Token åˆ—è¡¨
        function renderTokens(tokens) {
            const container = document.getElementById('token-list');

            if (tokens.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4">ğŸ“­</div>
                        <p class="text-lg">æš‚æ—  Tokenï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p>
                    </div>
                `;
                return;
            }

            // æŒ‰æ·»åŠ æ—¶é—´æ’åºï¼Œä¿æŒç¨³å®šé¡ºåº
            const sortedTokens = [...tokens].sort((a, b) => {
                const timeA = new Date(a.added_at || 0).getTime();
                const timeB = new Date(b.added_at || 0).getTime();
                return timeA - timeB;
            });

            container.innerHTML = sortedTokens.map(token => {
                const sub = token.subscription;
                const enabled = token.enabled;
                const statusColor = enabled ? 'green' : 'red';
                const statusText = enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';

                // ä½¿ç”¨é‚®ç®±åä½œä¸ºæ˜¾ç¤ºåç§°
                const displayName = sub?.employee_email || token.name;

                let creditPercent = 0;
                let creditColor = 'gray';
                if (sub && sub.credit_limit > 0) {
                    creditPercent = (sub.current_credits / sub.credit_limit) * 100;
                    if (creditPercent >= 70) creditColor = 'green';
                    else if (creditPercent >= 30) creditColor = 'yellow';
                    else creditColor = 'red';
                }

                return `
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-3 border-l-4 border-${statusColor}-500">
                        <!-- æ ‡é¢˜å’ŒæŒ‰é’®è¡Œ -->
                        <div class="flex items-center justify-between mb-2 flex-wrap gap-2">
                            <div class="flex items-center gap-2">
                                <h3 class="text-lg font-bold text-gray-800">${displayName}</h3>
                                <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-${statusColor}-100 text-${statusColor}-700">
                                    ${statusText}
                                </span>
                            </div>
                            <div class="flex gap-1.5">
                                <button onclick="refreshToken('${token.id}')" class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition">
                                    ğŸ”„ åˆ·æ–°
                                </button>
                                <button onclick="resetToken('${token.id}')" class="px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm font-medium transition">
                                    ğŸ”„ é‡ç½®
                                </button>
                                <button onclick="toggleToken('${token.id}')" class="px-3 py-1.5 bg-${enabled ? 'orange' : 'green'}-500 hover:bg-${enabled ? 'orange' : 'green'}-600 text-white rounded-lg text-sm font-medium transition">
                                    ${enabled ? 'âŒ ç¦ç”¨' : 'âœ… å¯ç”¨'}
                                </button>
                                <button onclick="deleteToken('${token.id}', '${displayName}')" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition">
                                    ğŸ—‘ï¸ åˆ é™¤
                                </button>
                            </div>
                        </div>

                        <!-- è®¢é˜…ä¿¡æ¯ -->
                        ${sub ? `
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
                                <div class="text-sm">
                                    <span class="text-gray-600">ç”¨æˆ·:</span>
                                    <span class="font-medium text-gray-800">${sub.user_name || '--'}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="text-gray-600">å¥—é¤:</span>
                                    <span class="font-medium text-gray-800">${sub.subscription_name || '--'}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="text-gray-600">å¤‡æ³¨:</span>
                                    <span class="font-medium text-gray-800">${token.name}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="text-gray-600">é‡ç½®æ¬¡æ•°:</span>
                                    <span class="font-medium text-gray-800">${sub.reset_times || 0} / 2</span>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">é¢åº¦ä½¿ç”¨</span>
                                    <span class="font-semibold text-gray-800">${creditPercent.toFixed(1)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-${creditColor}-500 h-2 rounded-full transition-all duration-300" style="width: ${creditPercent}%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-600 mt-0.5">
                                    <span>${sub.current_credits?.toFixed(2) || 0}</span>
                                    <span>${sub.credit_limit?.toFixed(2) || 0}</span>
                                </div>
                            </div>
                        ` : `
                            <div class="text-sm text-gray-500">æš‚æ— è®¢é˜…ä¿¡æ¯</div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // æ¨¡æ€æ¡†æ§åˆ¶
        function showAddTokenModal() {
            document.getElementById('new-token-name').value = '';
            document.getElementById('new-token-apikey').value = '';
            document.getElementById('add-token-error').classList.add('hidden');
            document.getElementById('add-token-modal').classList.remove('hidden');
        }

        function closeAddTokenModal() {
            document.getElementById('add-token-modal').classList.add('hidden');
        }

        function showBatchAddTokenModal() {
            document.getElementById('batch-token-prefix').value = '';
            document.getElementById('batch-token-apikeys').value = '';
            document.getElementById('batch-add-token-error').classList.add('hidden');
            document.getElementById('batch-add-token-modal').classList.remove('hidden');
        }

        function closeBatchAddTokenModal() {
            document.getElementById('batch-add-token-modal').classList.add('hidden');
        }

        // æ·»åŠ  Token
        function addToken() {
            const name = document.getElementById('new-token-name').value.trim();
            const apiKey = document.getElementById('new-token-apikey').value.trim();

            if (!apiKey) {
                alert('è¯·è¾“å…¥ API Key');
                return;
            }

            apiRequest('/api/tokens', {
                method: 'POST',
                body: JSON.stringify({ name: name || undefined, api_key: apiKey })
            })
            .then(data => {
                closeAddTokenModal();
                loadTokens();
                loadStatus();
                alert('Token æ·»åŠ æˆåŠŸï¼');
            })
            .catch(err => {
                const errorDiv = document.getElementById('add-token-error');
                errorDiv.textContent = 'æ·»åŠ å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯');
                errorDiv.classList.remove('hidden');
            });
        }

        // æ‰¹é‡æ·»åŠ  Token
        function batchAddTokens() {
            const prefix = document.getElementById('batch-token-prefix').value.trim();
            const apiKeys = document.getElementById('batch-token-apikeys').value.trim();

            if (!apiKeys) {
                alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ª API Key');
                return;
            }

            const errorDiv = document.getElementById('batch-add-token-error');
            errorDiv.textContent = 'æ­£åœ¨æ‰¹é‡æ·»åŠ ï¼Œè¯·ç¨å€™...';
            errorDiv.classList.remove('hidden');
            errorDiv.classList.remove('bg-red-50', 'border-red-200', 'text-red-700');
            errorDiv.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-700');

            apiRequest('/api/tokens/batch', {
                method: 'POST',
                body: JSON.stringify({ api_keys: apiKeys, prefix: prefix || '' })
            })
            .then(data => {
                closeBatchAddTokenModal();
                loadTokens();
                loadStatus();

                const message = `${data.message}\n\nè¯¦ç»†ä¿¡æ¯:\n` +
                    data.results.map(r =>
                        `${r.success ? 'âœ…' : 'âŒ'} ${r.name}: ${r.success ? 'æˆåŠŸ' : r.error}`
                    ).join('\n');
                alert(message);
            })
            .catch(err => {
                errorDiv.textContent = 'æ‰¹é‡æ·»åŠ å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯');
                errorDiv.classList.remove('bg-blue-50', 'border-blue-200', 'text-blue-700');
                errorDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-700');
            });
        }

        // Token æ“ä½œ
        function refreshToken(tokenId) {
            apiRequest(`/api/tokens/${tokenId}/refresh`, { method: 'PUT' })
                .then(data => loadTokens())
                .catch(err => console.error('åˆ·æ–°å¤±è´¥:', err.message));
        }

        function resetToken(tokenId) {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ­¤ Token çš„è®¢é˜…å—ï¼Ÿ')) return;

            apiRequest(`/api/tokens/${tokenId}/reset`, {
                method: 'PUT',
                body: JSON.stringify({ reset_type: 'second' })
            })
            .then(data => {
                loadTokens();
                loadStatus();
            })
            .catch(err => console.error('é‡ç½®å¤±è´¥:', err.message));
        }

        function toggleToken(tokenId) {
            apiRequest(`/api/tokens/${tokenId}/toggle`, { method: 'PUT' })
                .then(data => {
                    loadTokens();
                    loadStatus();
                })
                .catch(err => console.error('æ“ä½œå¤±è´¥:', err.message));
        }

        function deleteToken(tokenId, name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ Token "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;

            apiRequest(`/api/tokens/${tokenId}`, { method: 'DELETE' })
                .then(data => {
                    loadTokens();
                    loadStatus();
                })
                .catch(err => console.error('åˆ é™¤å¤±è´¥:', err.message));
        }

        function manualReset(resetType) {
            if (!confirm(`ç¡®å®šè¦æ‰‹åŠ¨è§¦å‘æ‰€æœ‰å¯ç”¨çš„ Token è¿›è¡Œ${resetType === 'first' ? 'ç¬¬ä¸€æ¬¡' : 'ç¬¬äºŒæ¬¡'}é‡ç½®å—ï¼Ÿ`)) return;

            apiRequest('/api/reset/trigger', {
                method: 'POST',
                body: JSON.stringify({ reset_type: resetType })
            })
            .then(data => {
                loadTokens();
                loadStatus();
            })
            .catch(err => console.error('é‡ç½®å¤±è´¥:', err.message));
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const addModal = document.getElementById('add-token-modal');
            const batchModal = document.getElementById('batch-add-token-modal');
            if (event.target === addModal) {
                closeAddTokenModal();
            }
            if (event.target === batchModal) {
                closeBatchAddTokenModal();
            }
        }
    </script>
</body>
</html>
