<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>88code 订阅重置管理后台</title>
    <!-- Tailwind CSS v3.4 CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                            950: '#172554',
                        },
                        secondary: {
                            50: '#faf5ff',
                            100: '#f3e8ff',
                            200: '#e9d5ff',
                            300: '#d8b4fe',
                            400: '#c084fc',
                            500: '#a855f7',
                            600: '#9333ea',
                            700: '#7e22ce',
                            800: '#6b21a8',
                            900: '#581c87',
                            950: '#3b0764',
                        },
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'slide-down': 'slideDown 0.4s ease-out',
                        'scale-in': 'scaleIn 0.3s ease-out',
                        'shimmer': 'shimmer 2s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-1000px 0' },
                            '100%': { backgroundPosition: '1000px 0' },
                        }
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'soft-lg': '0 10px 40px -10px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .gradient-purple {
            background: linear-gradient(135deg, #a855f7 0%, #7e22ce 100%);
        }

        .gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hover-scale {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .hover-scale:hover {
            transform: translateY(-2px) scale(1.01);
        }

        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }

        .loading-spinner {
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
        }

        .badge-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen antialiased">
    <!-- 登录页面 -->
    <div id="login-page" class="min-h-screen flex items-center justify-center px-4 relative overflow-hidden">
        <!-- 背景装饰 -->
        <div class="absolute inset-0 bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 opacity-90"></div>
        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4xIj48cGF0aCBkPSJNMzYgMzRjMC0yLjIxLTEuNzktNC00LTRzLTQgMS43OS00IDQgMS43OSA0IDQgNCA0LTEuNzkgNC00em0wLTEwYzAtMi4yMS0xLjc5LTQtNC00cy00IDEuNzktNCA0IDEuNzkgNCA0IDQgNC0xLjc5IDQtNHptMC0xMGMwLTIuMjEtMS43OS00LTQtNHMtNCAxLjc5LTQgNCAxLjc5IDQgNCA0IDQtMS43OSA0LTR6Ii8+PC9nPjwvZz48L3N2Zz4=')] opacity-20"></div>

        <div class="max-w-md w-full relative z-10 animate-scale-in">
            <div class="glass-morphism rounded-3xl shadow-2xl p-10 border border-white/30">
                <!-- Logo 和标题 -->
                <div class="text-center mb-8">
                    <div class="inline-flex items-center justify-center w-20 h-20 gradient-blue rounded-2xl mb-6 shadow-lg transform hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-rocket text-white text-3xl"></i>
                    </div>
                    <h1 class="text-4xl font-bold text-white mb-3 drop-shadow-lg">
                        88code 管理后台
                    </h1>
                    <p class="text-white/80 font-medium text-lg">请输入管理员密码以继续</p>
                </div>

                <!-- 登录表单 -->
                <div class="space-y-5">
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <i class="fas fa-lock text-gray-400 group-focus-within:text-blue-500 transition-colors"></i>
                        </div>
                        <input
                            type="password"
                            id="login-password"
                            placeholder="请输入管理员密码"
                            class="w-full pl-12 pr-4 py-4 bg-white/90 border-2 border-white/50 rounded-xl focus:ring-4 focus:ring-blue-500/30 focus:border-blue-500 outline-none transition-all duration-200 text-gray-800 placeholder-gray-400 font-medium"
                            onkeypress="if(event.key === 'Enter') login()"
                            autofocus
                        >
                    </div>

                    <div id="login-error" class="hidden bg-red-500/90 backdrop-blur-sm border border-red-400 text-white px-4 py-3 rounded-xl text-sm flex items-center gap-2 animate-slide-down">
                        <i class="fas fa-exclamation-circle"></i>
                        <span></span>
                    </div>

                    <button
                        onclick="login()"
                        class="w-full gradient-blue text-white font-bold py-4 rounded-xl hover:shadow-2xl hover:shadow-blue-500/50 transform hover:-translate-y-1 active:translate-y-0 transition-all duration-200 flex items-center justify-center gap-3 text-lg"
                    >
                        <i class="fas fa-sign-in-alt"></i>
                        <span>登录</span>
                    </button>
                </div>

                <!-- 底部提示 -->
                <div class="mt-6 text-center">
                    <p class="text-white/60 text-sm">
                        <i class="fas fa-shield-alt mr-1"></i>
                        安全登录 · 数据加密
                    </p>
                </div>
            </div>

            <!-- 版本信息 -->
            <div class="mt-6 text-center">
                <p class="text-white/70 text-sm font-medium">
                    88code Reset v1.6.0
                </p>
            </div>
        </div>
    </div>

    <!-- 主管理界面 -->
    <div id="main-app" class="hidden">
        <!-- 通知容器 -->
        <div id="notification-container" class="fixed top-6 right-6 z-50 space-y-3 max-w-md"></div>

        <!-- 顶部导航 -->
        <header class="glass-morphism shadow-soft-lg border-b border-white/50 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-6 lg:px-8 py-5">
                <div class="flex justify-between items-center">
                    <!-- Logo 和导航 -->
                    <div class="flex items-center gap-10">
                        <!-- Logo -->
                        <div class="flex items-center gap-3 group cursor-pointer">
                            <div class="w-11 h-11 gradient-blue rounded-xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                <i class="fas fa-rocket text-white text-lg"></i>
                            </div>
                            <div>
                                <h1 class="text-xl font-bold gradient-text leading-tight">88code</h1>
                                <p class="text-xs text-gray-500 font-medium">订阅重置管理</p>
                            </div>
                        </div>

                        <!-- 导航菜单 -->
                        <nav class="hidden md:flex gap-2">
                            <button
                                onclick="showPage('dashboard')"
                                id="nav-dashboard"
                                class="px-5 py-2.5 rounded-xl transition-all duration-200 bg-blue-50 text-blue-700 font-semibold hover-scale flex items-center gap-2 border-2 border-blue-200"
                            >
                                <i class="fas fa-chart-line"></i>
                                <span>主页</span>
                            </button>
                            <button
                                onclick="showPage('logs')"
                                id="nav-logs"
                                class="px-5 py-2.5 rounded-xl transition-all duration-200 hover:bg-gray-100 text-gray-600 font-semibold hover-scale flex items-center gap-2 border-2 border-transparent hover:border-gray-200"
                            >
                                <i class="fas fa-file-alt"></i>
                                <span>日志</span>
                            </button>
                        </nav>
                    </div>

                    <!-- 右侧操作 -->
                    <div class="flex items-center gap-3">
                        <!-- 状态指示器 -->
                        <div class="hidden lg:flex items-center gap-2 px-4 py-2 bg-green-50 rounded-xl border border-green-200">
                            <div class="w-2 h-2 bg-green-500 rounded-full badge-pulse"></div>
                            <span class="text-sm font-semibold text-green-700">运行中</span>
                        </div>

                        <!-- 退出按钮 -->
                        <button
                            onclick="logout()"
                            class="px-5 py-2.5 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 rounded-xl transition-all duration-200 font-semibold hover-scale flex items-center gap-2 border border-gray-300"
                        >
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="hidden sm:inline">退出</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 主页内容 -->
        <div id="page-dashboard" class="max-w-7xl mx-auto px-6 lg:px-8 py-8 space-y-8">
            <!-- 系统状态 -->
            <div class="bg-white rounded-3xl shadow-soft-lg p-8 card-hover border border-gray-100/50">
                <!-- 标题 -->
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-1.5 h-10 gradient-blue rounded-full"></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                            <i class="fas fa-chart-line text-blue-600"></i>
                            系统状态
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">实时监控系统运行状态</p>
                    </div>
                </div>

                <!-- 加载状态 -->
                <div id="status-loading" class="text-center py-16">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-500 font-medium">正在加载系统状态...</p>
                </div>

                <!-- 状态卡片 -->
                <div id="status-content" class="hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- 当前时间 -->
                        <div class="group relative bg-gradient-to-br from-blue-50 to-blue-100/50 rounded-2xl p-6 border-2 border-blue-200/50 hover:border-blue-300 transition-all duration-300 hover:shadow-lg overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/5 rounded-full -mr-16 -mt-16"></div>
                            <div class="relative">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-clock text-white text-2xl"></i>
                                    </div>
                                    <span class="text-xs font-bold text-blue-600 bg-blue-200/50 px-3 py-1.5 rounded-full">实时</span>
                                </div>
                                <div class="text-sm text-blue-700 font-semibold mb-2 uppercase tracking-wide">当前时间</div>
                                <div id="current-time" class="text-2xl font-bold text-blue-900">--:--:--</div>
                            </div>
                        </div>

                        <!-- 下次重置 -->
                        <div class="group relative bg-gradient-to-br from-emerald-50 to-emerald-100/50 rounded-2xl p-6 border-2 border-emerald-200/50 hover:border-emerald-300 transition-all duration-300 hover:shadow-lg overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/5 rounded-full -mr-16 -mt-16"></div>
                            <div class="relative">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-14 h-14 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-sync-alt text-white text-2xl"></i>
                                    </div>
                                    <span class="text-xs font-bold text-emerald-600 bg-emerald-200/50 px-3 py-1.5 rounded-full">下次</span>
                                </div>
                                <div class="text-sm text-emerald-700 font-semibold mb-2 uppercase tracking-wide">下次重置</div>
                                <div id="next-reset" class="text-2xl font-bold text-emerald-900">--:--</div>
                            </div>
                        </div>

                        <!-- Token 总数 -->
                        <div class="group relative bg-gradient-to-br from-purple-50 to-purple-100/50 rounded-2xl p-6 border-2 border-purple-200/50 hover:border-purple-300 transition-all duration-300 hover:shadow-lg overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-purple-500/5 rounded-full -mr-16 -mt-16"></div>
                            <div class="relative">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-14 h-14 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-key text-white text-2xl"></i>
                                    </div>
                                    <span class="text-xs font-bold text-purple-600 bg-purple-200/50 px-3 py-1.5 rounded-full">总计</span>
                                </div>
                                <div class="text-sm text-purple-700 font-semibold mb-2 uppercase tracking-wide">Token 总数</div>
                                <div id="total-tokens" class="text-2xl font-bold text-purple-900">0</div>
                            </div>
                        </div>

                        <!-- 已启用 Token -->
                        <div class="group relative bg-gradient-to-br from-amber-50 to-amber-100/50 rounded-2xl p-6 border-2 border-amber-200/50 hover:border-amber-300 transition-all duration-300 hover:shadow-lg overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-amber-500/5 rounded-full -mr-16 -mt-16"></div>
                            <div class="relative">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="w-14 h-14 bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                                        <i class="fas fa-check-circle text-white text-2xl"></i>
                                    </div>
                                    <span class="text-xs font-bold text-amber-600 bg-amber-200/50 px-3 py-1.5 rounded-full">启用</span>
                                </div>
                                <div class="text-sm text-amber-700 font-semibold mb-2 uppercase tracking-wide">已启用</div>
                                <div id="enabled-tokens" class="text-2xl font-bold text-amber-900">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 重置配置 -->
            <div class="bg-white rounded-3xl shadow-soft-lg p-8 card-hover border border-gray-100/50">
                <!-- 标题 -->
                <div class="flex items-center gap-3 mb-8">
                    <div class="w-1.5 h-10 gradient-purple rounded-full"></div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                            <i class="fas fa-cog text-purple-600"></i>
                            重置配置
                        </h2>
                        <p class="text-sm text-gray-500 mt-1">配置自动重置任务的触发条件</p>
                    </div>
                </div>

                <!-- 消息提示 -->
                <div id="config-error" class="hidden bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-200 text-red-700 px-5 py-4 rounded-2xl mb-6 flex items-center gap-3 animate-slide-down">
                    <i class="fas fa-exclamation-circle text-xl"></i>
                    <span class="font-medium"></span>
                </div>
                <div id="config-success" class="hidden bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-200 text-green-700 px-5 py-4 rounded-2xl mb-6 flex items-center gap-3 animate-slide-down">
                    <i class="fas fa-check-circle text-xl"></i>
                    <span class="font-medium"></span>
                </div>

                <!-- 配置卡片 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 第一次重置 -->
                    <div class="group relative bg-gradient-to-br from-indigo-50 via-indigo-50 to-indigo-100 rounded-2xl p-7 border-2 border-indigo-200/50 hover:border-indigo-300 transition-all duration-300 hover:shadow-xl overflow-hidden">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-indigo-500/5 rounded-full -mr-20 -mt-20"></div>
                        <div class="relative">
                            <!-- 头部 -->
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <i class="fas fa-sun text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-indigo-900">第一次重置</h3>
                                        <p class="text-xs text-indigo-600 font-medium">Evening Reset</p>
                                    </div>
                                </div>
                                <!-- 开关 -->
                                <label class="relative inline-flex items-center cursor-pointer group/switch">
                                    <input type="checkbox" id="first-enabled" class="sr-only peer">
                                    <div class="w-16 h-8 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-8 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-7 after:w-7 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-indigo-500 peer-checked:to-indigo-600 shadow-inner"></div>
                                </label>
                            </div>

                            <!-- 配置项 -->
                            <div class="space-y-5">
                                <div class="bg-white/60 rounded-xl p-4 border border-indigo-200/50">
                                    <label class="block text-sm font-bold text-indigo-800 mb-2 flex items-center gap-2">
                                        <i class="fas fa-clock text-indigo-500"></i>
                                        触发时间
                                    </label>
                                    <div class="text-2xl font-bold text-indigo-600">18:50</div>
                                </div>

                                <div class="bg-white/60 rounded-xl p-4 border border-indigo-200/50">
                                    <label class="block text-sm font-bold text-indigo-800 mb-3 flex items-center gap-2">
                                        <i class="fas fa-percentage text-indigo-500"></i>
                                        触发阈值
                                    </label>
                                    <div class="relative">
                                        <input
                                            type="number"
                                            id="first-threshold"
                                            min="0"
                                            max="100"
                                            value="70"
                                            class="w-full px-4 py-3 pr-12 border-2 border-indigo-300 rounded-xl focus:ring-4 focus:ring-indigo-200 focus:border-indigo-500 outline-none transition-all duration-200 font-bold text-lg text-indigo-900"
                                        >
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                                            <span class="text-indigo-500 font-bold text-lg">%</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-indigo-600 mt-3 flex items-center gap-2 bg-indigo-50 px-3 py-2 rounded-lg">
                                        <i class="fas fa-info-circle"></i>
                                        <span>当额度低于此百分比时触发重置</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 第二次重置 -->
                    <div class="group relative bg-gradient-to-br from-pink-50 via-pink-50 to-pink-100 rounded-2xl p-7 border-2 border-pink-200/50 hover:border-pink-300 transition-all duration-300 hover:shadow-xl overflow-hidden">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-pink-500/5 rounded-full -mr-20 -mt-20"></div>
                        <div class="relative">
                            <!-- 头部 -->
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl flex items-center justify-center shadow-lg">
                                        <i class="fas fa-moon text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-pink-900">第二次重置</h3>
                                        <p class="text-xs text-pink-600 font-medium">Night Reset</p>
                                    </div>
                                </div>
                                <!-- 开关 -->
                                <label class="relative inline-flex items-center cursor-pointer group/switch">
                                    <input type="checkbox" id="second-enabled" class="sr-only peer">
                                    <div class="w-16 h-8 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-8 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-7 after:w-7 after:transition-all peer-checked:bg-gradient-to-r peer-checked:from-pink-500 peer-checked:to-pink-600 shadow-inner"></div>
                                </label>
                            </div>

                            <!-- 配置项 -->
                            <div class="space-y-5">
                                <div class="bg-white/60 rounded-xl p-4 border border-pink-200/50">
                                    <label class="block text-sm font-bold text-pink-800 mb-2 flex items-center gap-2">
                                        <i class="fas fa-clock text-pink-500"></i>
                                        触发时间
                                    </label>
                                    <div class="text-2xl font-bold text-pink-600">23:55</div>
                                </div>

                                <div class="bg-white/60 rounded-xl p-4 border border-pink-200/50">
                                    <label class="block text-sm font-bold text-pink-800 mb-3 flex items-center gap-2">
                                        <i class="fas fa-percentage text-pink-500"></i>
                                        触发阈值
                                    </label>
                                    <div class="relative">
                                        <input
                                            type="number"
                                            id="second-threshold"
                                            min="0"
                                            max="100"
                                            value="100"
                                            class="w-full px-4 py-3 pr-12 border-2 border-pink-300 rounded-xl focus:ring-4 focus:ring-pink-200 focus:border-pink-500 outline-none transition-all duration-200 font-bold text-lg text-pink-900"
                                        >
                                        <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                                            <span class="text-pink-500 font-bold text-lg">%</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-pink-600 mt-3 flex items-center gap-2 bg-pink-50 px-3 py-2 rounded-lg">
                                        <i class="fas fa-info-circle"></i>
                                        <span>当额度低于此百分比时触发重置</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮 -->
                <div class="mt-8 flex flex-col sm:flex-row gap-4">
                    <button
                        onclick="saveConfig()"
                        class="flex-1 gradient-blue text-white font-bold px-8 py-4 rounded-xl hover:shadow-2xl hover:shadow-blue-500/30 transform hover:-translate-y-1 active:translate-y-0 transition-all duration-200 flex items-center justify-center gap-3 text-lg"
                    >
                        <i class="fas fa-save"></i>
                        <span>保存配置</span>
                    </button>
                    <button
                        onclick="manualReset()"
                        class="flex-1 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-bold px-8 py-4 rounded-xl hover:shadow-2xl hover:shadow-emerald-500/30 transform hover:-translate-y-1 active:translate-y-0 transition-all duration-200 flex items-center justify-center gap-3 text-lg"
                    >
                        <i class="fas fa-sync-alt"></i>
                        <span>手动重置</span>
                    </button>
                </div>
            </div>

            <!-- Token 管理 -->
            <div class="bg-white rounded-3xl shadow-soft-lg p-8 card-hover border border-gray-100/50">
                <!-- 标题和操作栏 -->
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-6">
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-10 bg-gradient-to-b from-blue-500 to-purple-600 rounded-full"></div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                                <i class="fas fa-key text-blue-600"></i>
                                Token 管理
                            </h2>
                            <p class="text-sm text-gray-500 mt-1">管理和监控所有 API Token</p>
                        </div>
                    </div>

                    <!-- 操作按钮组 -->
                    <div class="flex gap-3 flex-wrap">
                        <button
                            onclick="refreshAllTokens()"
                            class="bg-gradient-to-r from-cyan-500 to-cyan-600 text-white font-bold px-6 py-3 rounded-xl hover:shadow-xl hover:shadow-cyan-500/30 transform hover:-translate-y-1 active:translate-y-0 transition-all duration-200 flex items-center gap-2"
                        >
                            <i class="fas fa-sync-alt"></i>
                            <span>全部刷新</span>
                        </button>
                        <button
                            onclick="showAddTokenModal()"
                            class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-bold px-6 py-3 rounded-xl hover:shadow-xl hover:shadow-emerald-500/30 transform hover:-translate-y-1 active:translate-y-0 transition-all duration-200 flex items-center gap-2"
                        >
                            <i class="fas fa-plus"></i>
                            <span>添加 Token</span>
                        </button>
                        <button
                            onclick="showBatchAddTokenModal()"
                            class="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold px-6 py-3 rounded-xl hover:shadow-xl hover:shadow-blue-500/30 transform hover:-translate-y-1 active:translate-y-0 transition-all duration-200 flex items-center gap-2"
                        >
                            <i class="fas fa-layer-group"></i>
                            <span>批量添加</span>
                        </button>
                    </div>
                </div>

                <!-- 加载状态 -->
                <div id="token-loading" class="text-center py-16">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-500 font-medium">正在加载 Token 列表...</p>
                </div>

                <!-- Token 列表 -->
                <div id="token-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- 日志页面 -->
        <div id="page-logs" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white rounded-2xl shadow-xl p-6 hover-lift border border-gray-100">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-2 h-8 bg-gradient-to-b from-primary-500 to-secondary-600 rounded-full"></div>
                        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-file-alt text-primary-500"></i>
                            系统日志
                        </h2>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="clearLogs()" class="bg-red-500 hover:bg-red-600 text-white font-semibold px-5 py-2.5 rounded-xl transition-all duration-200 flex items-center gap-2 hover-lift">
                            <i class="fas fa-trash"></i>
                            清空日志
                        </button>
                        <button onclick="loadLogs()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-5 py-2.5 rounded-xl transition-all duration-200 flex items-center gap-2 hover-lift">
                            <i class="fas fa-sync-alt"></i>
                            刷新
                        </button>
                    </div>
                </div>

                <div class="mb-6 flex gap-2 flex-wrap">
                    <button onclick="filterLogs('all')" id="filter-all" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl text-sm font-medium transition-all duration-200 hover-lift">
                        <i class="fas fa-list mr-1"></i>
                        全部
                    </button>
                    <button onclick="filterLogs('info')" id="filter-info" class="px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-xl text-sm font-medium transition-all duration-200 hover-lift">
                        <i class="fas fa-info-circle mr-1"></i>
                        信息
                    </button>
                    <button onclick="filterLogs('success')" id="filter-success" class="px-4 py-2 bg-green-50 hover:bg-green-100 text-green-700 rounded-xl text-sm font-medium transition-all duration-200 hover-lift">
                        <i class="fas fa-check-circle mr-1"></i>
                        成功
                    </button>
                    <button onclick="filterLogs('warning')" id="filter-warning" class="px-4 py-2 bg-amber-50 hover:bg-amber-100 text-amber-700 rounded-xl text-sm font-medium transition-all duration-200 hover-lift">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        警告
                    </button>
                    <button onclick="filterLogs('error')" id="filter-error" class="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-700 rounded-xl text-sm font-medium transition-all duration-200 hover-lift">
                        <i class="fas fa-times-circle mr-1"></i>
                        错误
                    </button>
                </div>

                <div class="bg-gray-900 rounded-2xl p-4 font-mono text-sm h-[600px] overflow-y-auto custom-scrollbar border border-gray-800">
                    <div id="log-content" class="space-y-2">
                        <div class="text-gray-500 flex items-center gap-2">
                            <i class="fas fa-hourglass-half"></i>
                            等待日志加载...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加 Token 模态框 -->
    <div id="add-token-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center px-4 z-50">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 transform transition-all duration-300 scale-95 opacity-0" id="add-token-modal-content">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-plus text-white text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">添加新 Token</h3>
            </div>
            <div id="add-token-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl mb-4 text-sm flex items-center gap-2">
                <i class="fas fa-exclamation-circle"></i>
                <span></span>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-tag text-gray-400"></i>
                        Token 名称
                    </label>
                    <input
                        type="text"
                        id="new-token-name"
                        placeholder="例如: 账号A"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all duration-200"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-key text-gray-400"></i>
                        API Key
                    </label>
                    <input
                        type="text"
                        id="new-token-apikey"
                        placeholder="sk-ant-..."
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all duration-200 font-mono"
                    >
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button
                    onclick="closeAddTokenModal()"
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 rounded-xl transition-all duration-200 hover-lift"
                >
                    取消
                </button>
                <button
                    onclick="addToken()"
                    class="flex-1 bg-gradient-to-r from-primary-600 to-secondary-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200"
                >
                    添加
                </button>
            </div>
        </div>
    </div>

    <!-- 批量添加 Token 模态框 -->
    <div id="batch-add-token-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center px-4 z-50">
        <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full p-8 transform transition-all duration-300 scale-95 opacity-0" id="batch-add-token-modal-content">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-layer-group text-white text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800">批量添加 Token</h3>
            </div>
            <div id="batch-add-token-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl mb-4 text-sm flex items-center gap-2">
                <i class="fas fa-exclamation-circle"></i>
                <span></span>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-tag text-gray-400"></i>
                        Token 名称前缀（可选）
                    </label>
                    <input
                        type="text"
                        id="batch-token-prefix"
                        placeholder="例如: 账号"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none transition-all duration-200"
                    >
                    <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                        <i class="fas fa-info-circle"></i>
                        如果不填，将自动命名为 Token-1, Token-2...
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-key text-gray-400"></i>
                        API Keys（每行一个）
                    </label>
                    <textarea
                        id="batch-token-apikeys"
                        rows="10"
                        placeholder="sk-ant-...&#10;sk-ant-...&#10;sk-ant-..."
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-transparent outline-none font-mono text-sm custom-scrollbar transition-all duration-200"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-2 flex items-center gap-1">
                        <i class="fas fa-info-circle"></i>
                        支持多个 API Key，每行一个
                    </p>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button
                    onclick="closeBatchAddTokenModal()"
                    class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 rounded-xl transition-all duration-200 hover-lift"
                >
                    取消
                </button>
                <button
                    onclick="batchAddTokens()"
                    class="flex-1 bg-gradient-to-r from-primary-600 to-secondary-600 text-white font-semibold py-3 rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-200"
                >
                    批量添加
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let adminToken = '';

        // 通知系统
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');

            const colors = {
                success: 'bg-emerald-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-amber-500'
            };

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };

            notification.className = `${colors[type]} text-white px-6 py-4 rounded-xl shadow-xl flex items-center gap-3 transform transition-all duration-300 opacity-0 translate-x-4`;
            notification.innerHTML = `
                <i class="fas ${icons[type]} text-xl"></i>
                <span class="font-medium">${message}</span>
            `;

            container.appendChild(notification);

            // 触发动画
            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-x-4');
            }, 10);

            // 3秒后移除
            setTimeout(() => {
                notification.classList.add('opacity-0', 'translate-x-4');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // 登录功能
        function login() {
            const password = document.getElementById('login-password').value.trim();
            if (!password) {
                showLoginError('请输入密码');
                return;
            }

            adminToken = password;
            localStorage.setItem('adminToken', adminToken);

            // 测试认证
            apiRequest('/api/status', { method: 'GET' })
                .then(() => {
                    document.getElementById('login-page').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    initApp();
                })
                .catch(err => {
                    showLoginError('密码错误，请重试');
                    adminToken = '';
                    localStorage.removeItem('adminToken');
                });
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.querySelector('span').textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 3000);
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }

        // 页面切换
        let currentPage = 'dashboard';
        let logInterval = null;
        let allLogs = [];
        let currentFilter = 'all';
        let isTokensLoaded = false; // 标记 Token 是否已加载过

        function showPage(pageName) {
            // 更新导航按钮状态
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('bg-primary-100', 'text-primary-700');
                btn.classList.add('hover:bg-gray-100');
            });
            document.getElementById(`nav-${pageName}`).classList.add('bg-primary-100', 'text-primary-700');
            document.getElementById(`nav-${pageName}`).classList.remove('hover:bg-gray-100');

            // 切换页面显示
            document.getElementById('page-dashboard').classList.add('hidden');
            document.getElementById('page-logs').classList.add('hidden');
            document.getElementById(`page-${pageName}`).classList.remove('hidden');

            currentPage = pageName;

            // 如果切换到日志页面，加载日志并开始自动刷新
            if (pageName === 'logs') {
                loadLogs();
                if (logInterval) clearInterval(logInterval);
                logInterval = setInterval(loadLogs, 5000); // 每5秒刷新一次
            } else {
                // 离开日志页面时停止自动刷新
                if (logInterval) {
                    clearInterval(logInterval);
                    logInterval = null;
                }
            }
        }

        // 日志管理
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            allLogs.unshift({
                timestamp,
                message,
                type,
                id: Date.now()
            });

            // 保留最近 500 条日志
            if (allLogs.length > 500) {
                allLogs = allLogs.slice(0, 500);
            }

            // 保存到 localStorage
            localStorage.setItem('systemLogs', JSON.stringify(allLogs));

            // 如果当前在日志页面，更新显示
            if (currentPage === 'logs') {
                renderLogs();
            }
        }

        function loadLogs() {
            // 从 API 获取系统日志
            apiRequest('/api/system-logs')
                .then(data => {
                    const systemLogs = (data.logs || []).map(log => ({
                        timestamp: new Date(log.timestamp).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        }),
                        message: log.message,
                        type: log.type,
                        id: new Date(log.timestamp).getTime(),
                        source: 'system' // 标记为系统日志
                    }));

                    // 获取客户端日志
                    const savedLogs = localStorage.getItem('systemLogs');
                    const clientLogs = savedLogs ? JSON.parse(savedLogs).map(log => ({
                        ...log,
                        source: 'client' // 标记为客户端日志
                    })) : [];

                    // 合并系统日志和客户端日志
                    allLogs = [...systemLogs, ...clientLogs];

                    // 按时间排序（最新的在前）
                    allLogs.sort((a, b) => b.id - a.id);

                    // 限制总日志数
                    if (allLogs.length > 500) {
                        allLogs = allLogs.slice(0, 500);
                    }

                    renderLogs();
                })
                .catch(err => {
                    console.error('加载系统日志失败:', err);
                    // 如果 API 失败，只显示客户端日志
                    const savedLogs = localStorage.getItem('systemLogs');
                    if (savedLogs) {
                        allLogs = JSON.parse(savedLogs);
                    }
                    renderLogs();
                });
        }

        function renderLogs() {
            const container = document.getElementById('log-content');
            const filteredLogs = currentFilter === 'all'
                ? allLogs
                : allLogs.filter(log => log.type === currentFilter);

            if (filteredLogs.length === 0) {
                container.innerHTML = '<div class="text-gray-500 flex items-center gap-2"><i class="fas fa-inbox"></i> 暂无日志</div>';
                return;
            }

            const typeColors = {
                info: 'text-blue-400',
                success: 'text-emerald-400',
                warning: 'text-amber-400',
                error: 'text-red-400'
            };

            const typeIcons = {
                info: 'fa-info-circle',
                success: 'fa-check-circle',
                warning: 'fa-exclamation-triangle',
                error: 'fa-times-circle'
            };

            container.innerHTML = filteredLogs.map(log => {
                const sourceLabel = log.source === 'system' ? '<span class="text-purple-400 bg-purple-900/30 px-2 py-0.5 rounded text-xs">[系统]</span> ' : '';
                return `
                    <div class="hover:bg-gray-800 px-3 py-2 rounded-lg transition-colors duration-200">
                        <span class="text-gray-500 text-xs">[${log.timestamp}]</span>
                        ${sourceLabel}
                        <i class="fas ${typeIcons[log.type]} ${typeColors[log.type]} text-xs ml-2 mr-1"></i>
                        <span class="text-gray-300">${log.message}</span>
                    </div>
                `;
            }).join('');

            // 自动滚动到底部
            const logContainer = document.getElementById('log-content').parentElement;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function filterLogs(type) {
            currentFilter = type;

            // 更新按钮状态
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-primary-500');
            });
            document.getElementById(`filter-${type}`).classList.add('ring-2', 'ring-primary-500');

            renderLogs();
        }

        function clearLogs() {
            if (!confirm('确定要清空所有日志吗？')) return;
            allLogs = [];
            localStorage.removeItem('systemLogs');
            renderLogs();
            showNotification('日志已清空', 'success');
        }

        // 初始化应用
        function initApp() {
            loadStatus();
            loadConfig();
            loadTokens();
            setInterval(loadStatus, 30000);
        }

        // 页面加载时检查登录状态
        window.onload = function() {
            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                adminToken = savedToken;
                apiRequest('/api/status', { method: 'GET' })
                    .then(() => {
                        document.getElementById('login-page').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        initApp();
                    })
                    .catch(() => {
                        localStorage.removeItem('adminToken');
                    });
            }
        };

        // API 请求封装
        function apiRequest(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminToken}`
            };

            return fetch(API_BASE + url, {
                ...options,
                headers: { ...headers, ...options.headers }
            }).then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                    }
                    return response.json().then(data => {
                        throw new Error(data.error || 'Request failed');
                    });
                }
                return response.json();
            });
        }

        // 加载系统状态
        function loadStatus() {
            apiRequest('/api/status')
                .then(data => {
                    document.getElementById('status-loading').classList.add('hidden');
                    document.getElementById('status-content').classList.remove('hidden');

                    const currentTime = new Date(data.current_time).toLocaleString('zh-CN');
                    const nextResetTime = new Date(data.next_reset_time).toLocaleString('zh-CN');
                    const resetType = data.next_reset_type === 'first' ? '第一次' : '第二次';

                    document.getElementById('current-time').textContent = currentTime;
                    document.getElementById('next-reset').textContent = `${nextResetTime} (${resetType})`;
                    document.getElementById('total-tokens').textContent = data.total_tokens;
                    document.getElementById('enabled-tokens').textContent = data.enabled_tokens;
                })
                .catch(err => console.error('加载状态失败:', err));
        }

        // 加载配置
        function loadConfig() {
            apiRequest('/api/config')
                .then(data => {
                    document.getElementById('first-enabled').checked = data.first_reset.enabled;
                    document.getElementById('first-threshold').value = data.first_reset.threshold_percent;
                    document.getElementById('second-enabled').checked = data.second_reset.enabled;
                    document.getElementById('second-threshold').value = data.second_reset.threshold_percent;
                })
                .catch(err => console.error('加载配置失败:', err));
        }

        // 保存配置
        function saveConfig() {
            const config = {
                first_reset: {
                    enabled: document.getElementById('first-enabled').checked,
                    hour: 18,
                    minute: 50,
                    threshold_percent: parseFloat(document.getElementById('first-threshold').value)
                },
                second_reset: {
                    enabled: document.getElementById('second-enabled').checked,
                    hour: 23,
                    minute: 55,
                    threshold_percent: parseFloat(document.getElementById('second-threshold').value)
                },
                timezone: 'Asia/Shanghai',
                web_port: 8966
            };

            addLog(`保存配置: 第一次=${config.first_reset.enabled}, 第二次=${config.second_reset.enabled}`, 'info');
            apiRequest('/api/config', {
                method: 'PUT',
                body: JSON.stringify(config)
            })
            .then(data => {
                addLog('配置保存成功', 'success');
                const successDiv = document.getElementById('config-success');
                successDiv.querySelector('span').textContent = '配置保存成功！';
                successDiv.classList.remove('hidden');
                setTimeout(() => successDiv.classList.add('hidden'), 3000);
            })
            .catch(err => {
                addLog(`配置保存失败: ${err.message}`, 'error');
                const errorDiv = document.getElementById('config-error');
                errorDiv.querySelector('span').textContent = '保存失败: ' + err.message;
                errorDiv.classList.remove('hidden');
            });
        }

        // 加载 Token 列表
        function loadTokens() {
            // 只在首次加载时显示 loading
            if (!isTokensLoaded) {
                document.getElementById('token-loading').classList.remove('hidden');
            }

            apiRequest('/api/tokens')
                .then(data => {
                    document.getElementById('token-loading').classList.add('hidden');
                    renderTokens(data.tokens || []);
                    isTokensLoaded = true; // 标记已加载
                })
                .catch(err => {
                    document.getElementById('token-loading').classList.add('hidden');
                    console.error('加载 Token 失败:', err);
                });
        }

        // 获取 Token 显示名称（优先使用邮箱名）
        function getTokenDisplayName(token) {
            return token.subscription?.employee_email || token.name || token.id;
        }

        // 渲染 Token 列表
        function renderTokens(tokens) {
            const container = document.getElementById('token-list');

            if (tokens.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16 text-gray-500">
                        <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-inbox text-4xl text-gray-400"></i>
                        </div>
                        <p class="text-lg font-medium">暂无 Token</p>
                        <p class="text-sm mt-2">点击上方按钮添加</p>
                    </div>
                `;
                return;
            }

            // 按添加时间排序，保持稳定顺序
            const sortedTokens = [...tokens].sort((a, b) => {
                const timeA = new Date(a.added_at || 0).getTime();
                const timeB = new Date(b.added_at || 0).getTime();
                return timeA - timeB;
            });

            container.innerHTML = sortedTokens.map(token => {
                const sub = token.subscription;
                const enabled = token.enabled;
                const statusColor = enabled ? 'emerald' : 'red';
                const statusText = enabled ? '已启用' : '已禁用';

                // 使用邮箱名作为显示名称
                const displayName = sub?.employee_email || token.name;

                let creditPercent = 0;
                let creditColor = 'gray';
                if (sub && sub.credit_limit > 0) {
                    creditPercent = (sub.current_credits / sub.credit_limit) * 100;
                    if (creditPercent >= 70) creditColor = 'emerald';
                    else if (creditPercent >= 30) creditColor = 'amber';
                    else creditColor = 'red';
                }

                return `
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl p-5 border-l-4 border-${statusColor}-500 hover-lift">
                        <!-- 标题和按钮行 -->
                        <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-${statusColor}-500 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-${enabled ? 'check' : 'times'} text-white"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-gray-800">${displayName}</h3>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-700">
                                        <i class="fas fa-circle text-${statusColor}-400 mr-1.5" style="font-size: 6px;"></i>
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="refreshToken('${token.id}')" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-xl text-sm font-medium transition-all duration-200 hover-lift flex items-center gap-1">
                                    <i class="fas fa-sync-alt"></i>
                                    刷新
                                </button>
                                <button onclick="resetToken('${token.id}')" class="px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-xl text-sm font-medium transition-all duration-200 hover-lift flex items-center gap-1">
                                    <i class="fas fa-redo"></i>
                                    重置
                                </button>
                                <button onclick="toggleToken('${token.id}')" class="px-3 py-2 bg-${enabled ? 'amber' : 'emerald'}-500 hover:bg-${enabled ? 'amber' : 'emerald'}-600 text-white rounded-xl text-sm font-medium transition-all duration-200 hover-lift flex items-center gap-1">
                                    <i class="fas fa-${enabled ? 'pause' : 'play'}"></i>
                                    ${enabled ? '禁用' : '启用'}
                                </button>
                                <button onclick="deleteToken('${token.id}', '${displayName}')" class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-xl text-sm font-medium transition-all duration-200 hover-lift flex items-center gap-1">
                                    <i class="fas fa-trash"></i>
                                    删除
                                </button>
                            </div>
                        </div>

                        <!-- 订阅信息 -->
                        ${sub ? `
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                                <div class="bg-white/70 rounded-lg p-3">
                                    <div class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                                        <i class="fas fa-user"></i>
                                        用户
                                    </div>
                                    <div class="text-sm font-medium text-gray-800">${sub.user_name || '--'}</div>
                                </div>
                                <div class="bg-white/70 rounded-lg p-3">
                                    <div class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                                        <i class="fas fa-crown"></i>
                                        套餐
                                    </div>
                                    <div class="text-sm font-medium text-gray-800">${sub.subscription_name || '--'}</div>
                                </div>
                                <div class="bg-white/70 rounded-lg p-3">
                                    <div class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                                        <i class="fas fa-tag"></i>
                                        备注
                                    </div>
                                    <div class="text-sm font-medium text-gray-800">${token.name}</div>
                                </div>
                                <div class="bg-white/70 rounded-lg p-3">
                                    <div class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                                        <i class="fas fa-redo"></i>
                                        重置次数
                                    </div>
                                    <div class="text-sm font-medium text-gray-800">${sub.reset_times || 0} / 2</div>
                                </div>
                            </div>

                            <div class="bg-white/70 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm text-gray-600 flex items-center gap-1">
                                        <i class="fas fa-chart-pie"></i>
                                        额度使用
                                    </span>
                                    <span class="text-sm font-semibold text-gray-800">${sub.current_credits?.toFixed(2) || 0} / ${sub.credit_limit?.toFixed(2) || 0} (${creditPercent.toFixed(1)}%)</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                    <div class="bg-${creditColor}-500 h-3 rounded-full transition-all duration-500 ease-out relative" style="width: ${creditPercent}%">
                                        <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="text-sm text-gray-500 flex items-center gap-2">
                                <i class="fas fa-exclamation-circle"></i>
                                暂无订阅信息
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // 模态框控制
        function showAddTokenModal() {
            document.getElementById('new-token-name').value = '';
            document.getElementById('new-token-apikey').value = '';
            document.getElementById('add-token-error').classList.add('hidden');
            document.getElementById('add-token-modal').classList.remove('hidden');
            setTimeout(() => {
                const modal = document.getElementById('add-token-modal-content');
                modal.classList.remove('scale-95', 'opacity-0');
                modal.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeAddTokenModal() {
            const modal = document.getElementById('add-token-modal-content');
            modal.classList.remove('scale-100', 'opacity-100');
            modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                document.getElementById('add-token-modal').classList.add('hidden');
            }, 300);
        }

        function showBatchAddTokenModal() {
            document.getElementById('batch-token-prefix').value = '';
            document.getElementById('batch-token-apikeys').value = '';
            document.getElementById('batch-add-token-error').classList.add('hidden');
            document.getElementById('batch-add-token-modal').classList.remove('hidden');
            setTimeout(() => {
                const modal = document.getElementById('batch-add-token-modal-content');
                modal.classList.remove('scale-95', 'opacity-0');
                modal.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeBatchAddTokenModal() {
            const modal = document.getElementById('batch-add-token-modal-content');
            modal.classList.remove('scale-100', 'opacity-100');
            modal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                document.getElementById('batch-add-token-modal').classList.add('hidden');
            }, 300);
        }

        // 添加 Token
        function addToken() {
            const name = document.getElementById('new-token-name').value.trim();
            const apiKey = document.getElementById('new-token-apikey').value.trim();

            if (!apiKey) {
                showNotification('请输入 API Key', 'warning');
                return;
            }

            addLog(`正在添加 Token: ${name || 'Unnamed'}`, 'info');
            apiRequest('/api/tokens', {
                method: 'POST',
                body: JSON.stringify({ name: name || undefined, api_key: apiKey })
            })
            .then(data => {
                closeAddTokenModal();
                loadTokens();
                loadStatus();
                addLog(`Token 添加成功: ${getTokenDisplayName(data.token)}`, 'success');
                showNotification('Token 添加成功！', 'success');
            })
            .catch(err => {
                addLog(`Token 添加失败: ${name || 'Unnamed'} - ${err.message}`, 'error');
                const errorDiv = document.getElementById('add-token-error');
                errorDiv.querySelector('span').textContent = '添加失败: ' + (err.message || '未知错误');
                errorDiv.classList.remove('hidden');
            });
        }

        // 批量添加 Token
        function batchAddTokens() {
            const prefix = document.getElementById('batch-token-prefix').value.trim();
            const apiKeys = document.getElementById('batch-token-apikeys').value.trim();

            if (!apiKeys) {
                showNotification('请输入至少一个 API Key', 'warning');
                return;
            }

            const lines = apiKeys.split('\n').filter(line => line.trim());
            addLog(`开始批量添加 Token: ${lines.length} 个`, 'info');

            const errorDiv = document.getElementById('batch-add-token-error');
            errorDiv.querySelector('span').textContent = '正在批量添加，请稍候...';
            errorDiv.classList.remove('hidden');
            errorDiv.classList.remove('bg-red-50', 'border-red-200', 'text-red-700');
            errorDiv.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-700');

            apiRequest('/api/tokens/batch', {
                method: 'POST',
                body: JSON.stringify({ api_keys: apiKeys, prefix: prefix || '' })
            })
            .then(data => {
                closeBatchAddTokenModal();
                loadTokens();
                loadStatus();
                addLog(`批量添加完成: 成功 ${data.success_count}, 失败 ${data.fail_count}`, data.fail_count > 0 ? 'warning' : 'success');
                showNotification(`批量添加完成: 成功 ${data.success_count}, 失败 ${data.fail_count}`, 'success');
            })
            .catch(err => {
                addLog(`批量添加失败: ${err.message}`, 'error');
                errorDiv.querySelector('span').textContent = '批量添加失败: ' + (err.message || '未知错误');
                errorDiv.classList.remove('bg-blue-50', 'border-blue-200', 'text-blue-700');
                errorDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-700');
            });
        }

        // Token 操作
        function refreshToken(tokenId) {
            const requestUrl = `/api/tokens/${tokenId}/refresh`;
            const requestMethod = 'PUT';

            addLog(`🔵 API请求: ${requestMethod} ${requestUrl}`, 'info');
            addLog(`正在刷新 Token: ${tokenId}`, 'info');

            apiRequest(requestUrl, { method: requestMethod })
                .then(data => {
                    addLog(`🟢 API响应: ${JSON.stringify(data)}`, 'success');
                    loadTokens();
                    addLog(`Token 刷新成功: ${getTokenDisplayName(data.token)}`, 'success');
                    showNotification('订阅信息已刷新', 'success');
                })
                .catch(err => {
                    addLog(`🔴 API错误: ${err.message}`, 'error');
                    addLog(`Token 刷新失败: ${tokenId} - ${err.message}`, 'error');
                    showNotification('刷新失败: ' + err.message, 'error');
                });
        }

        function refreshAllTokens() {
            apiRequest('/api/tokens')
                .then(data => {
                    const tokens = data.tokens || [];
                    const enabledTokens = tokens.filter(t => t.enabled);

                    if (enabledTokens.length === 0) {
                        showNotification('没有启用的 Token', 'warning');
                        return;
                    }

                    if (!confirm(`确定要刷新所有 ${enabledTokens.length} 个启用的 Token 吗？`)) {
                        return;
                    }

                    addLog(`开始批量刷新: ${enabledTokens.length} 个启用的 Token`, 'info');
                    showNotification(`开始批量刷新 ${enabledTokens.length} 个 Token...`, 'info');

                    let successCount = 0;
                    let failCount = 0;
                    let completedCount = 0;

                    // 刷新每个 Token，间隔 1 秒避免请求过快
                    enabledTokens.forEach((token, index) => {
                        setTimeout(() => {
                            const requestUrl = `/api/tokens/${token.id}/refresh`;
                            const requestMethod = 'PUT';

                            addLog(`🔵 [批量刷新 ${index + 1}/${enabledTokens.length}] API请求: ${requestMethod} ${requestUrl}`, 'info');

                            apiRequest(requestUrl, { method: requestMethod })
                                .then(data => {
                                    addLog(`🟢 [批量刷新 ${index + 1}/${enabledTokens.length}] API响应: ${JSON.stringify(data)}`, 'success');
                                    addLog(`Token 刷新成功: ${getTokenDisplayName(token)}`, 'success');
                                    successCount++;
                                })
                                .catch(err => {
                                    addLog(`🔴 [批量刷新 ${index + 1}/${enabledTokens.length}] API错误: ${err.message}`, 'error');
                                    addLog(`Token 刷新失败: ${getTokenDisplayName(token)} - ${err.message}`, 'error');
                                    failCount++;
                                })
                                .finally(() => {
                                    completedCount++;
                                    if (completedCount === enabledTokens.length) {
                                        loadTokens();
                                        loadStatus();
                                        const message = `批量刷新完成: 成功 ${successCount}, 失败 ${failCount}`;
                                        addLog(message, failCount > 0 ? 'warning' : 'success');
                                        showNotification(message, failCount > 0 ? 'warning' : 'success');
                                    }
                                });
                        }, index * 1000); // 每个 Token 间隔 1 秒
                    });
                })
                .catch(err => {
                    addLog(`获取 Token 列表失败: ${err.message}`, 'error');
                    showNotification('获取 Token 列表失败', 'error');
                });
        }

        function resetToken(tokenId) {
            if (!confirm('确定要重置此 Token 的订阅吗？')) return;

            addLog(`正在重置 Token: ${tokenId}`, 'info');
            apiRequest(`/api/tokens/${tokenId}/reset`, {
                method: 'PUT',
                body: JSON.stringify({ reset_type: 'second' })
            })
            .then(data => {
                loadTokens();
                loadStatus();
                addLog(`Token 重置成功: ${getTokenDisplayName(data.token)}`, 'success');
                showNotification('重置成功！', 'success');
            })
            .catch(err => {
                addLog(`Token 重置失败: ${tokenId} - ${err.message}`, 'error');
                console.error('重置失败:', err.message);
            });
        }

        function toggleToken(tokenId) {
            apiRequest(`/api/tokens/${tokenId}/toggle`, { method: 'PUT' })
                .then(data => {
                    loadTokens();
                    loadStatus();
                    const action = data.token.enabled ? '启用' : '禁用';
                    addLog(`Token ${action}: ${getTokenDisplayName(data.token)}`, 'success');
                    showNotification(data.token.enabled ? 'Token 已启用' : 'Token 已禁用', 'success');
                })
                .catch(err => {
                    addLog(`Token 切换状态失败: ${tokenId} - ${err.message}`, 'error');
                    console.error('操作失败:', err.message);
                });
        }

        function deleteToken(tokenId, name) {
            if (!confirm(`确定要删除 Token "${name}" 吗？此操作不可恢复！`)) return;

            addLog(`正在删除 Token: ${name} (${tokenId})`, 'warning');
            apiRequest(`/api/tokens/${tokenId}`, { method: 'DELETE' })
                .then(data => {
                    loadTokens();
                    loadStatus();
                    addLog(`Token 已删除: ${name}`, 'success');
                    showNotification('Token 已删除', 'success');
                })
                .catch(err => {
                    addLog(`Token 删除失败: ${name} - ${err.message}`, 'error');
                    console.error('删除失败:', err.message);
                });
        }

        function manualReset() {
            // 获取当前配置，确定使用哪个重置类型
            const config = {
                first_reset: {
                    enabled: document.getElementById('first-enabled').checked,
                },
                second_reset: {
                    enabled: document.getElementById('second-enabled').checked,
                }
            };

            // 优先使用第二次重置，如果未启用则使用第一次
            let resetType = 'second';
            if (!config.second_reset.enabled && config.first_reset.enabled) {
                resetType = 'first';
            }

            if (!confirm(`确定要手动触发所有启用的 Token 进行重置吗？`)) return;

            addLog(`手动触发重置: 类型=${resetType}`, 'info');
            apiRequest('/api/reset/trigger', {
                method: 'POST',
                body: JSON.stringify({ reset_type: resetType })
            })
            .then(data => {
                loadTokens();
                loadStatus();
                addLog(`手动重置完成: 成功 ${data.success_count}/${data.total}`, 'success');
                showNotification(`重置完成！成功: ${data.success_count}/${data.total}`, 'success');
            })
            .catch(err => {
                addLog(`手动重置失败: ${err.message}`, 'error');
                console.error('重置失败:', err.message);
            });
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const addModal = document.getElementById('add-token-modal');
            const batchModal = document.getElementById('batch-add-token-modal');
            if (event.target === addModal) {
                closeAddTokenModal();
            }
            if (event.target === batchModal) {
                closeBatchAddTokenModal();
            }
        }
    </script>
</body>
</html>