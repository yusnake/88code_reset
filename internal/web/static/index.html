<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>88code 订阅重置管理后台</title>
    <!-- Tailwind CSS v3.0 CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#667eea',
                        secondary: '#764ba2',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <!-- 登录页面 -->
    <div id="login-page" class="min-h-screen flex items-center justify-center px-4 bg-gradient-to-br from-primary to-secondary">
        <div class="max-w-md w-full">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">🔐 88code 管理后台</h1>
                    <p class="text-gray-600">请输入管理员密码以继续</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">管理员密码</label>
                        <input
                            type="password"
                            id="login-password"
                            placeholder="请输入密码"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition"
                            onkeypress="if(event.key === 'Enter') login()"
                        >
                    </div>
                    <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                    <button
                        onclick="login()"
                        class="w-full bg-gradient-to-r from-primary to-secondary text-white font-semibold py-3 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200"
                    >
                        登录
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 主管理界面 -->
    <div id="main-app" class="hidden">
        <!-- 顶部导航 -->
        <header class="bg-gradient-to-r from-primary to-secondary text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex justify-between items-center">
                    <h1 class="text-3xl font-bold">🚀 88code 订阅重置管理</h1>
                    <button onclick="logout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                        退出登录
                    </button>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- 系统状态 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="w-2 h-8 bg-primary rounded-full mr-3"></span>
                    📊 系统状态
                </h2>
                <div id="status-loading" class="text-center py-8 text-gray-500">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-primary"></div>
                    <p class="mt-2">加载中...</p>
                </div>
                <div id="status-content" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border-l-4 border-blue-500">
                            <div class="text-sm text-blue-600 font-medium mb-1">当前时间</div>
                            <div id="current-time" class="text-xl font-bold text-blue-900">--</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border-l-4 border-green-500">
                            <div class="text-sm text-green-600 font-medium mb-1">下次重置</div>
                            <div id="next-reset" class="text-xl font-bold text-green-900">--</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border-l-4 border-purple-500">
                            <div class="text-sm text-purple-600 font-medium mb-1">Token 总数</div>
                            <div id="total-tokens" class="text-xl font-bold text-purple-900">0</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border-l-4 border-orange-500">
                            <div class="text-sm text-orange-600 font-medium mb-1">已启用 Token</div>
                            <div id="enabled-tokens" class="text-xl font-bold text-orange-900">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 重置配置 -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <span class="w-2 h-8 bg-primary rounded-full mr-3"></span>
                    ⚙️ 重置配置
                </h2>
                <div id="config-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>
                <div id="config-success" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4"></div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 第一次重置 -->
                    <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-indigo-900">🌅 第一次重置 (18:50)</h3>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="first-enabled" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-indigo-700 mb-2">触发阈值 (%)</label>
                            <input
                                type="number"
                                id="first-threshold"
                                min="0"
                                max="100"
                                value="70"
                                class="w-full px-4 py-2 border border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                            >
                            <p class="text-xs text-indigo-600 mt-2">当额度低于此百分比时触发重置</p>
                        </div>
                    </div>

                    <!-- 第二次重置 -->
                    <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-pink-900">🌙 第二次重置 (23:55)</h3>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="second-enabled" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-600"></div>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-pink-700 mb-2">触发阈值 (%)</label>
                            <input
                                type="number"
                                id="second-threshold"
                                min="0"
                                max="100"
                                value="100"
                                class="w-full px-4 py-2 border border-pink-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent outline-none"
                            >
                            <p class="text-xs text-pink-600 mt-2">当额度低于此百分比时触发重置</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button
                        onclick="saveConfig()"
                        class="bg-gradient-to-r from-primary to-secondary text-white font-semibold px-6 py-3 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200"
                    >
                        💾 保存配置
                    </button>
                    <button
                        onclick="manualReset('first')"
                        class="bg-gradient-to-r from-indigo-500 to-indigo-600 text-white font-semibold px-6 py-3 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200"
                    >
                        🔄 手动触发第一次重置
                    </button>
                    <button
                        onclick="manualReset('second')"
                        class="bg-gradient-to-r from-pink-500 to-pink-600 text-white font-semibold px-6 py-3 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200"
                    >
                        🔄 手动触发第二次重置
                    </button>
                </div>
            </div>

            <!-- Token 管理 -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <span class="w-2 h-8 bg-primary rounded-full mr-3"></span>
                        🔑 Token 管理
                    </h2>
                    <div class="flex gap-3">
                        <button
                            onclick="showAddTokenModal()"
                            class="bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold px-4 py-2 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200 flex items-center gap-2"
                        >
                            <span class="text-xl">➕</span> 添加 Token
                        </button>
                        <button
                            onclick="showBatchAddTokenModal()"
                            class="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:shadow-lg transform hover:-translate-y-0.5 transition duration-200 flex items-center gap-2"
                        >
                            <span class="text-xl">📝</span> 批量添加
                        </button>
                    </div>
                </div>
                <div id="token-loading" class="text-center py-8 text-gray-500">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-300 border-t-primary"></div>
                    <p class="mt-2">加载中...</p>
                </div>
                <div id="token-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- 添加 Token 模态框 -->
    <div id="add-token-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 transform transition-all">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">➕ 添加新 Token</h3>
            <div id="add-token-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm"></div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Token 名称</label>
                    <input
                        type="text"
                        id="new-token-name"
                        placeholder="例如: 账号A"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                    >
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                    <input
                        type="text"
                        id="new-token-apikey"
                        placeholder="sk-ant-..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                    >
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button
                    onclick="closeAddTokenModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg transition"
                >
                    取消
                </button>
                <button
                    onclick="addToken()"
                    class="flex-1 bg-gradient-to-r from-primary to-secondary text-white font-semibold py-2 rounded-lg hover:shadow-lg transition"
                >
                    添加
                </button>
            </div>
        </div>
    </div>

    <!-- 批量添加 Token 模态框 -->
    <div id="batch-add-token-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center px-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 transform transition-all">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">📝 批量添加 Token</h3>
            <div id="batch-add-token-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm"></div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Token 名称前缀（可选）</label>
                    <input
                        type="text"
                        id="batch-token-prefix"
                        placeholder="例如: 账号"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
                    >
                    <p class="text-xs text-gray-500 mt-1">如果不填，将自动命名为 Token-1, Token-2...</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Keys（每行一个）</label>
                    <textarea
                        id="batch-token-apikeys"
                        rows="10"
                        placeholder="sk-ant-...&#10;sk-ant-...&#10;sk-ant-..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none font-mono text-sm"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">支持多个 API Key，每行一个</p>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button
                    onclick="closeBatchAddTokenModal()"
                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg transition"
                >
                    取消
                </button>
                <button
                    onclick="batchAddTokens()"
                    class="flex-1 bg-gradient-to-r from-primary to-secondary text-white font-semibold py-2 rounded-lg hover:shadow-lg transition"
                >
                    批量添加
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let adminToken = '';

        // 登录功能
        function login() {
            const password = document.getElementById('login-password').value.trim();
            if (!password) {
                showLoginError('请输入密码');
                return;
            }

            adminToken = password;
            localStorage.setItem('adminToken', adminToken);

            // 测试认证
            apiRequest('/api/status', { method: 'GET' })
                .then(() => {
                    document.getElementById('login-page').classList.add('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    initApp();
                })
                .catch(err => {
                    showLoginError('密码错误，请重试');
                    adminToken = '';
                    localStorage.removeItem('adminToken');
                });
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 3000);
        }

        function logout() {
            localStorage.removeItem('adminToken');
            location.reload();
        }

        // 初始化应用
        function initApp() {
            loadStatus();
            loadConfig();
            loadTokens();
            setInterval(loadStatus, 30000);
        }

        // 页面加载时检查登录状态
        window.onload = function() {
            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                adminToken = savedToken;
                apiRequest('/api/status', { method: 'GET' })
                    .then(() => {
                        document.getElementById('login-page').classList.add('hidden');
                        document.getElementById('main-app').classList.remove('hidden');
                        initApp();
                    })
                    .catch(() => {
                        localStorage.removeItem('adminToken');
                    });
            }
        };

        // API 请求封装
        function apiRequest(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${adminToken}`
            };

            return fetch(API_BASE + url, {
                ...options,
                headers: { ...headers, ...options.headers }
            }).then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                    }
                    return response.json().then(data => {
                        throw new Error(data.error || 'Request failed');
                    });
                }
                return response.json();
            });
        }

        // 加载系统状态
        function loadStatus() {
            apiRequest('/api/status')
                .then(data => {
                    document.getElementById('status-loading').classList.add('hidden');
                    document.getElementById('status-content').classList.remove('hidden');

                    const currentTime = new Date(data.current_time).toLocaleString('zh-CN');
                    const nextResetTime = new Date(data.next_reset_time).toLocaleString('zh-CN');
                    const resetType = data.next_reset_type === 'first' ? '第一次' : '第二次';

                    document.getElementById('current-time').textContent = currentTime;
                    document.getElementById('next-reset').textContent = `${nextResetTime} (${resetType})`;
                    document.getElementById('total-tokens').textContent = data.total_tokens;
                    document.getElementById('enabled-tokens').textContent = data.enabled_tokens;
                })
                .catch(err => console.error('加载状态失败:', err));
        }

        // 加载配置
        function loadConfig() {
            apiRequest('/api/config')
                .then(data => {
                    document.getElementById('first-enabled').checked = data.first_reset.enabled;
                    document.getElementById('first-threshold').value = data.first_reset.threshold_percent;
                    document.getElementById('second-enabled').checked = data.second_reset.enabled;
                    document.getElementById('second-threshold').value = data.second_reset.threshold_percent;
                })
                .catch(err => console.error('加载配置失败:', err));
        }

        // 保存配置
        function saveConfig() {
            const config = {
                first_reset: {
                    enabled: document.getElementById('first-enabled').checked,
                    hour: 18,
                    minute: 50,
                    threshold_percent: parseFloat(document.getElementById('first-threshold').value)
                },
                second_reset: {
                    enabled: document.getElementById('second-enabled').checked,
                    hour: 23,
                    minute: 55,
                    threshold_percent: parseFloat(document.getElementById('second-threshold').value)
                },
                timezone: 'Asia/Shanghai',
                web_port: 8966
            };

            apiRequest('/api/config', {
                method: 'PUT',
                body: JSON.stringify(config)
            })
            .then(data => {
                const successDiv = document.getElementById('config-success');
                successDiv.textContent = '✅ 配置保存成功！';
                successDiv.classList.remove('hidden');
                setTimeout(() => successDiv.classList.add('hidden'), 3000);
            })
            .catch(err => {
                const errorDiv = document.getElementById('config-error');
                errorDiv.textContent = '❌ 保存失败: ' + err.message;
                errorDiv.classList.remove('hidden');
            });
        }

        // 加载 Token 列表
        function loadTokens() {
            document.getElementById('token-loading').classList.remove('hidden');

            apiRequest('/api/tokens')
                .then(data => {
                    document.getElementById('token-loading').classList.add('hidden');
                    renderTokens(data.tokens || []);
                })
                .catch(err => {
                    document.getElementById('token-loading').classList.add('hidden');
                    console.error('加载 Token 失败:', err);
                });
        }

        // 渲染 Token 列表
        function renderTokens(tokens) {
            const container = document.getElementById('token-list');

            if (tokens.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4">📭</div>
                        <p class="text-lg">暂无 Token，点击上方按钮添加</p>
                    </div>
                `;
                return;
            }

            // 按添加时间排序，保持稳定顺序
            const sortedTokens = [...tokens].sort((a, b) => {
                const timeA = new Date(a.added_at || 0).getTime();
                const timeB = new Date(b.added_at || 0).getTime();
                return timeA - timeB;
            });

            container.innerHTML = sortedTokens.map(token => {
                const sub = token.subscription;
                const enabled = token.enabled;
                const statusColor = enabled ? 'green' : 'red';
                const statusText = enabled ? '已启用' : '已禁用';

                // 使用邮箱名作为显示名称
                const displayName = sub?.employee_email || token.name;

                let creditPercent = 0;
                let creditColor = 'gray';
                if (sub && sub.credit_limit > 0) {
                    creditPercent = (sub.current_credits / sub.credit_limit) * 100;
                    if (creditPercent >= 70) creditColor = 'green';
                    else if (creditPercent >= 30) creditColor = 'yellow';
                    else creditColor = 'red';
                }

                return `
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-3 border-l-4 border-${statusColor}-500">
                        <!-- 标题和按钮行 -->
                        <div class="flex items-center justify-between mb-2 flex-wrap gap-2">
                            <div class="flex items-center gap-2">
                                <h3 class="text-lg font-bold text-gray-800">${displayName}</h3>
                                <span class="px-2 py-0.5 rounded-full text-xs font-semibold bg-${statusColor}-100 text-${statusColor}-700">
                                    ${statusText}
                                </span>
                            </div>
                            <div class="flex gap-1.5">
                                <button onclick="refreshToken('${token.id}')" class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition">
                                    🔄 刷新
                                </button>
                                <button onclick="resetToken('${token.id}')" class="px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm font-medium transition">
                                    🔄 重置
                                </button>
                                <button onclick="toggleToken('${token.id}')" class="px-3 py-1.5 bg-${enabled ? 'orange' : 'green'}-500 hover:bg-${enabled ? 'orange' : 'green'}-600 text-white rounded-lg text-sm font-medium transition">
                                    ${enabled ? '❌ 禁用' : '✅ 启用'}
                                </button>
                                <button onclick="deleteToken('${token.id}', '${displayName}')" class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition">
                                    🗑️ 删除
                                </button>
                            </div>
                        </div>

                        <!-- 订阅信息 -->
                        ${sub ? `
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
                                <div class="text-sm">
                                    <span class="text-gray-600">用户:</span>
                                    <span class="font-medium text-gray-800">${sub.user_name || '--'}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="text-gray-600">套餐:</span>
                                    <span class="font-medium text-gray-800">${sub.subscription_name || '--'}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="text-gray-600">备注:</span>
                                    <span class="font-medium text-gray-800">${token.name}</span>
                                </div>
                                <div class="text-sm">
                                    <span class="text-gray-600">重置次数:</span>
                                    <span class="font-medium text-gray-800">${sub.reset_times || 0} / 2</span>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-gray-600">额度使用</span>
                                    <span class="font-semibold text-gray-800">${creditPercent.toFixed(1)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-${creditColor}-500 h-2 rounded-full transition-all duration-300" style="width: ${creditPercent}%"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-600 mt-0.5">
                                    <span>${sub.current_credits?.toFixed(2) || 0}</span>
                                    <span>${sub.credit_limit?.toFixed(2) || 0}</span>
                                </div>
                            </div>
                        ` : `
                            <div class="text-sm text-gray-500">暂无订阅信息</div>
                        `}
                    </div>
                `;
            }).join('');
        }

        // 模态框控制
        function showAddTokenModal() {
            document.getElementById('new-token-name').value = '';
            document.getElementById('new-token-apikey').value = '';
            document.getElementById('add-token-error').classList.add('hidden');
            document.getElementById('add-token-modal').classList.remove('hidden');
        }

        function closeAddTokenModal() {
            document.getElementById('add-token-modal').classList.add('hidden');
        }

        function showBatchAddTokenModal() {
            document.getElementById('batch-token-prefix').value = '';
            document.getElementById('batch-token-apikeys').value = '';
            document.getElementById('batch-add-token-error').classList.add('hidden');
            document.getElementById('batch-add-token-modal').classList.remove('hidden');
        }

        function closeBatchAddTokenModal() {
            document.getElementById('batch-add-token-modal').classList.add('hidden');
        }

        // 添加 Token
        function addToken() {
            const name = document.getElementById('new-token-name').value.trim();
            const apiKey = document.getElementById('new-token-apikey').value.trim();

            if (!apiKey) {
                alert('请输入 API Key');
                return;
            }

            apiRequest('/api/tokens', {
                method: 'POST',
                body: JSON.stringify({ name: name || undefined, api_key: apiKey })
            })
            .then(data => {
                closeAddTokenModal();
                loadTokens();
                loadStatus();
                alert('Token 添加成功！');
            })
            .catch(err => {
                const errorDiv = document.getElementById('add-token-error');
                errorDiv.textContent = '添加失败: ' + (err.message || '未知错误');
                errorDiv.classList.remove('hidden');
            });
        }

        // 批量添加 Token
        function batchAddTokens() {
            const prefix = document.getElementById('batch-token-prefix').value.trim();
            const apiKeys = document.getElementById('batch-token-apikeys').value.trim();

            if (!apiKeys) {
                alert('请输入至少一个 API Key');
                return;
            }

            const errorDiv = document.getElementById('batch-add-token-error');
            errorDiv.textContent = '正在批量添加，请稍候...';
            errorDiv.classList.remove('hidden');
            errorDiv.classList.remove('bg-red-50', 'border-red-200', 'text-red-700');
            errorDiv.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-700');

            apiRequest('/api/tokens/batch', {
                method: 'POST',
                body: JSON.stringify({ api_keys: apiKeys, prefix: prefix || '' })
            })
            .then(data => {
                closeBatchAddTokenModal();
                loadTokens();
                loadStatus();

                const message = `${data.message}\n\n详细信息:\n` +
                    data.results.map(r =>
                        `${r.success ? '✅' : '❌'} ${r.name}: ${r.success ? '成功' : r.error}`
                    ).join('\n');
                alert(message);
            })
            .catch(err => {
                errorDiv.textContent = '批量添加失败: ' + (err.message || '未知错误');
                errorDiv.classList.remove('bg-blue-50', 'border-blue-200', 'text-blue-700');
                errorDiv.classList.add('bg-red-50', 'border-red-200', 'text-red-700');
            });
        }

        // Token 操作
        function refreshToken(tokenId) {
            apiRequest(`/api/tokens/${tokenId}/refresh`, { method: 'PUT' })
                .then(data => loadTokens())
                .catch(err => console.error('刷新失败:', err.message));
        }

        function resetToken(tokenId) {
            if (!confirm('确定要重置此 Token 的订阅吗？')) return;

            apiRequest(`/api/tokens/${tokenId}/reset`, {
                method: 'PUT',
                body: JSON.stringify({ reset_type: 'second' })
            })
            .then(data => {
                loadTokens();
                loadStatus();
            })
            .catch(err => console.error('重置失败:', err.message));
        }

        function toggleToken(tokenId) {
            apiRequest(`/api/tokens/${tokenId}/toggle`, { method: 'PUT' })
                .then(data => {
                    loadTokens();
                    loadStatus();
                })
                .catch(err => console.error('操作失败:', err.message));
        }

        function deleteToken(tokenId, name) {
            if (!confirm(`确定要删除 Token "${name}" 吗？此操作不可恢复！`)) return;

            apiRequest(`/api/tokens/${tokenId}`, { method: 'DELETE' })
                .then(data => {
                    loadTokens();
                    loadStatus();
                })
                .catch(err => console.error('删除失败:', err.message));
        }

        function manualReset(resetType) {
            if (!confirm(`确定要手动触发所有启用的 Token 进行${resetType === 'first' ? '第一次' : '第二次'}重置吗？`)) return;

            apiRequest('/api/reset/trigger', {
                method: 'POST',
                body: JSON.stringify({ reset_type: resetType })
            })
            .then(data => {
                loadTokens();
                loadStatus();
            })
            .catch(err => console.error('重置失败:', err.message));
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const addModal = document.getElementById('add-token-modal');
            const batchModal = document.getElementById('batch-add-token-modal');
            if (event.target === addModal) {
                closeAddTokenModal();
            }
            if (event.target === batchModal) {
                closeBatchAddTokenModal();
            }
        }
    </script>
</body>
</html>
